---
title: "Reproducing the COVID-19 semi-log greater than 100 cumulative cases graph"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{cumulative-cases}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r libraries}
library(covidrecon)
library(dplyr)
library(ggplot2)
```

https://blog.grattan.edu.au/2020/03/australian-governments-can-choose-to-slow-the-spread-of-coronavirus-but-they-must-act-immediately/

```{r get-latest-data}
jhu_covid_cumulative_cases <- covid_pull_data()
```

```{r high-incidence-countries}
high_incidence_countries <- covid_high_incidence(jhu_covid_cumulative_cases) %>% 
  mutate(alpha = ifelse(country_region == "Australia", 1, 0.7)) %>% 
  filter(normalised_date >= 0)
```

```{r select-countries}
selected_countries <- c("China",
                        "Singapore",
                        "Japan",
                        "Iran",
                        "Italy",
                        "Spain",
                        "US",
                        "United Kingdom",
                        "Australia",
                        "France",
                        "Korea, South")

```


```{r get-latest-data-highlight}
library(gghighlight)

gg_covid_cumulative(high_incidence_countries)

high_incidence_countries %>% 
  covid_filter_countres(c("Australia",
                          "Italy")) %>% 
  add_country_label() %>% 
  gg_covid_cumulative() +
  geom_covid_country_label() +
  scale_x_continuous(expand = expansion(add = c(1, 3)))
```

```{r}
highlight_countries <- c("Japan",
                         "Korea, South",
                         "Singapore",
                         "Italy",
                         "Iran",
                         "China",
                         "France",
                         "United Kingdom",
                         "Sweden",
                         "Australia")

high_incidence_countries_extra <- high_incidence_countries %>%
  covid_highlight_australia_plus(plus = highlight_countries) %>% 
  add_country_label() %>% 
  filter(normalised_date >= 0,
         country_region != "Cruise Ship")
```

```{r}
gg <- 
ggplot(
  data = high_incidence_countries_extra,
  aes(
    x = normalised_date,
    y = cumulative_cases,
    colour = country_region,
    alpha = alpha,
    # tooltip = country_region,
    # data_id = country_region
  )
) +
  geom_line() +
  geom_covid_country_label() +
  scale_y_log10(labels = scales::comma) +
  scale_alpha(range = c(0.2, 1)) +
  # scale_x_continuous(expand = expansion(add = c(1, 3))) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    y = "Cumulative cases (logarithmic scale)",
    x = "Days since cumulative cases exceeded 100",
    title = paste("COVID-19 epidemic trajectories up to", format(
      max(high_incidence_countries_extra$date), "%d %B %Y"
    )),
    subtitle = "(click on a line to identify country)",
    caption = paste0(
      "CC-BY-SA-NC Tim Churches (UNSW) & Nick Tierney (Monash)\n",
      "Data source: Johns Hopkins University"
    )
  )

gg
```



```{r eval = FALSE}
library(lubridate)

gg + 
  geom_line_interactive(size = 1.2) %>% 
girafe(ggobj = .,
       options = list(
         opts_tooltip(use_stroke = TRUE, opacity = 0.7),
         opts_hover(css = "stroke:black;"),
         opts_toolbar(position = "topright", saveaspng = TRUE)
       ))

hubei_incidence_function_data <- provinces_confirmed_jh %>%
      filter(date >= ymd("2020-01-11")) %>% 
      mutate(HubeiSansWuhan = if_else(
        condition = is.na(HubeiSansWuhan), 
        true = 0, 
        false = HubeiSansWuhan)) %>%
      mutate(incident_cases = ifelse(Date < ymd("2020-02-15"),
                                     Wuhan + HubeiSansWuhan, Hubei)) %>% mutate(date = format(date, 
    "%Y-%m-%d")) %>% 
    select(Date, incident_cases) 
    %>% uncount(incident_cases)
hubei_incidence_object <- incidence(hubei_incidence_function_data$Date)
```

